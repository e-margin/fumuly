# 封筒管理システム 要件定義書

**作成日**: 2026-02-23  
**改訂日**: 2026-02-23（v2）  
**ステータス**: MVP設計フェーズ

---

## 概要

ADHDや認知的負荷の高いユーザーが、郵便物・封筒の内容を把握・管理するためのシステム。  
写真を撮るだけでClaude APIが内容を解析し、重要度・種類・期限を自動分類して記録する。

---

## コアコンセプト

「熟読しなくていい」「開封してスキャンするだけでいい」

---

## ユーザー像（ペルソナ）

- ADHD傾向があり、書類の仕分け・期限管理が困難
- 封筒を開けること自体にハードルを感じる
- 電話での問い合わせが苦手
- 複数の債務・行政手続きが並行している
- 一人暮らしで管理を手伝ってくれる人がいない

---

## ローンチ戦略

| フェーズ | 対象 | 目的 |
|---------|------|------|
| MVP（現在） | 自分・知人（招待制） | 動作検証・UX改善・法務整備 |
| v1.0 | 一般公開PWA | プライバシーポリシー整備後に公開 |
| v2.0 | BtoB展開 | 障害福祉サービス事業所など |

---

## 機能要件

### 0. ユーザープロフィール設定（初期設定）

- 初回起動時に以下の生活状況を入力してもらう
  - 収入種別・月収（給与 / 年金 / 生活保護 / 無職など）
  - 既存の負債概要（総額・主な債権者）
  - 特性（ADHD・電話困難・その他）
  - 現在の状況（差押執行済み・免除申請中など自由記述）
- 入力内容はシステムプロンプトに組み込み、解析精度・アドバイスのトーンを最適化する
- 設定画面からいつでも更新可能

### 1. 封筒スキャン・解析

- スマホカメラで封筒・書類を撮影（複数枚可）
- Claude Vision APIで内容を自動解析
- 以下の情報を抽出：
  - 送付元（機関名・企業名）
  - 書類の種類（請求書 / 督促状 / 案内 / 勧誘 / 証明書 など）
  - 金額（該当する場合）
  - 期限・支払期日
  - 対応の要否
  - 優先度（高 / 中 / 低 / 無視可）

### 2. 自動分類

カテゴリ：
- 🔴 緊急対応（差押、督促、期限切れ間近）
- 🟡 要対応（申請、手続き、支払い）
- 🟢 保管のみ（証明書、控え）
- ⚪ 破棄可（勧誘、案内、DM）

### 3. 記録・一覧管理

- 解析結果テキストをSupabaseに保存（画像はローカルのみ保持）
- 一覧画面で全書類を確認可能
- フィルタ・ソート（期限順、優先度順など）
- 対応済みフラグ
- ユーザーによる全データ削除機能（必須）

### 4. リマインダー

- 期限が近い書類の通知
- 対応が必要な書類の未処理アラート

### 5. 書面詳細要約

- スキャンした書類の内容を、ユーザーの生活状況を踏まえてやさしく説明する
- 免除・猶予・減額制度など利用できる可能性のある制度を示唆する
- 電話番号・問い合わせ先を抽出し、電話不要の代替手段を優先案内する
- 複数の書類を横断的に理解した上で状況を説明する（擬似ステートフル）
- 解析結果には「AIによる参考情報である」旨の免責事項を表示する

### 6. アクションガイド

- 「次に何をすべきか」を具体的にテキストで提示
- 例：「この書類はコンビニで支払えます」「このWebフォームから申請できます」
- 可能な限り電話不要の代替手段を提示

---

## 非機能要件

- スマホ（PWA）でメインで使えること
- **オフライン対応**：過去の解析結果はService Workerでキャッシュし、オフライン時も閲覧可能
- **データ設計方針**：画像データは端末内（IndexedDB）のみに保存。Supabaseにはテキスト解析結果のみ送信
- シンプルなUI（認知負荷を下げる）

---

## 技術スタック

| レイヤー | 技術 | 補足 |
|--------|------|------|
| フロントエンド | React PWA | |
| バックエンド | Node.js / Express | |
| データベース | Supabase（PostgreSQL）| テキストデータのみ保存 |
| ローカルストレージ | IndexedDB | 画像データはここに保持 |
| AI解析 | Claude API（Vision）| `claude-sonnet-4-6` |
| ホスティング | Vercel（フロント）+ Supabase（DB）| |
| 認証 | Supabase Auth | |
| オフライン | Service Worker | Workboxを使用 |

---

## データ保存設計

### 画像データの取り扱い方針

```
撮影
  ↓
画像をIndexedDB（端末内）に一時保存
  ↓
base64エンコードしてClaude APIへ送信（解析のみ）
  ↓
解析結果（テキスト）をSupabaseへ保存
  ↓
画像はIndexedDB内に保持（ユーザーが削除可能）
```

**この設計の理由：**
- 氏名・住所・金融情報・債務情報などセンシティブな画像をクラウドに置かない
- 法的リスクを最小化しながらも、解析済みテキストはデバイスをまたいで参照可能

### Supabaseに保存するデータ

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "created_at": "timestamp",
  "sender": "送付元名",
  "type": "書類種別",
  "amount": 12000,
  "deadline": "2026-03-31",
  "action_required": true,
  "priority": "high",
  "summary": "電気代の督促状",
  "recommended_action": "コンビニまたはWebから3/31までに支払い",
  "category": "urgent",
  "is_done": false
}
```

---

## Claude API 実装設計

### システムプロンプト（精度向上のため必須）

```javascript
const SYSTEM_PROMPT = `
あなたは日本の郵便物・書類を解析する専門AIです。
以下のルールに従って解析してください：

【優先度判定ルール】
- "差押"、"強制執行"、"法的措置"、"最終通告" → priority: "high"（例外なし）
- "督促"、"延滞"、"至急"、"期限" → priority: "high"
- 支払期日まで7日以内 → priority: "high"
- 申請・手続きの案内 → priority: "medium"
- 証明書・通知書 → priority: "low"
- DM・広告・勧誘 → priority: "ignore"

【金額の扱い】
- 「今月の請求額」と「分割払い残高」が混在する場合、今月の支払い額を amount に入れる
- 複数金額がある場合は最も直近の支払い義務が発生する金額を優先

【手書き・印字混在】
- 手書き部分は可能な限り読み取り、不明な場合は null を使用

必ずJSON形式のみで返答してください。説明文は不要です。
`;
```

### APIリクエスト

```javascript
const response = await fetch("https://api.anthropic.com/v1/messages", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    model: "claude-sonnet-4-6",
    max_tokens: 1000,
    system: SYSTEM_PROMPT,
    messages: [{
      role: "user",
      content: [
        {
          type: "image",
          source: { type: "base64", media_type: "image/jpeg", data: base64Image }
        },
        {
          type: "text",
          text: `この書類を解析して以下のJSON形式で返してください：
{
  "sender": "送付元",
  "type": "書類種別",
  "amount": 金額（円、なければnull）,
  "deadline": "期限（YYYY-MM-DD、なければnull）",
  "action_required": true/false,
  "priority": "high/medium/low/ignore",
  "summary": "一言で内容を説明",
  "recommended_action": "次にすべき具体的な行動（電話不要の手段を優先）"
}`
        }
      ]
    }]
  })
});
```

### オフライン時の撮影キューイング

```javascript
// オフライン時はIndexedDBにキューとして保存し、オンライン復帰時に自動送信
if (!navigator.onLine) {
  await saveToOfflineQueue(imageData);
  showToast("オフラインです。ネット接続時に自動で解析します");
} else {
  await analyzeAndSave(imageData);
}
```

---

## 法務・プライバシー対応

### MVPフェーズで必須の対応

**① 初回起動時の同意画面（必須）**

以下を明示した同意確認画面を設ける：

```
このアプリは書類画像をAI（Anthropic Claude）に送信して解析します。
・送信されるデータ：書類の画像（一時的）
・画像はAnthropicのサーバーで処理され、アプリには保存されません
・解析結果のテキストのみがクラウドに保存されます
・Anthropicのプライバシーポリシー：https://www.anthropic.com/privacy

[同意して始める]  [キャンセル]
```

**② データ削除機能（必須）**

- 設定画面に「すべてのデータを削除」ボタンを設置
- Supabase上のレコードとIndexedDB内の画像を完全削除
- 削除完了の確認メッセージを表示

**③ Anthropic APIの設定確認（必須）**

- Anthropic APIコンソールにて「トレーニングデータへの使用をオプトアウト」の設定を確認・適用すること
- 参照：https://console.anthropic.com

### 一般公開時（v1.0）に追加で必要なもの

- プライバシーポリシーページの策定・公開（個人情報保護法に準拠）
- 利用規約の策定・公開
- Anthropicへのデータ送信に関する明示的な記載
- お問い合わせ窓口の設置

---

## 画面構成

1. **オンボーディング** - 初回のみ。データの扱い説明と同意確認
2. **ホーム** - 未対応書類の一覧、緊急度順
3. **スキャン** - カメラ起動 → 撮影 → 解析中（ローディング）→ 解析結果確認 → 保存
4. **一覧** - 全書類、フィルタ・ソート
5. **詳細** - 書類の解析結果、ローカル保存画像、対応履歴
6. **設定** - 通知設定、データ削除

---

## 将来的な拡張（v2以降）

- 家計管理との連携（収支ドキュメントへの自動反映）
- 行政手続きのテンプレート自動生成
- 複数ユーザー対応（家族間共有）
- BtoB展開（障害福祉サービス事業所など）
- 月額課金モデルの設計

---

## 今後の検討事項

- 月額課金モデルの設計（Claude API利用コストとの兼ね合い）
- App Storeに依存しないPWA戦略
- 画像のローカル保存をどこまで長期維持するか（容量・削除ポリシー）
- 一般公開前の法律専門家へのレビュー依頼
